<!-- map -->
<div id="map" style="width: 100%; height: 30vh;"></div>
<!-- cloison -->
<div class="block-center">
  <div class="trip-edit">
    <% if @trip.user == current_user %>
    <p>edit<%= link_to edit_trip_path(@trip) do%>
    <i class="fa fa-pencil" aria-hidden="true"></i></p>
    <% end %>
    <% end %>
  </div>
</div>
<!-- banner infos -->
<div class="banner-trip">
  <div class="trip-title-container">
    <div class="trip-title">
      <h1> <%= @trip.title %> </h1>
    </div>
    <div class="trip-cities">
      <p>From: <%= @trip.from %> - To: <%= @trip.to %> (<%= @trip.estimated_duration %>h trip) <br>
      Date: <%= @trip.starts_at %> </p>
    </div>
  </div>
  <div class="trip-status">
    <p>Trip status: <br> <%= @trip.status %></p>
  </div>
</div>
<!-- description -->
<div class="trip-infos">
  <div class="host-info">
    <div class=" img-circle img-trip-host" style="background-image: url(<%= @trip.user.facebook_picture_url %>)">
    </div>
    <div class="info-trip-host">
      <hr>
      <p><%= @trip.user.first_name %> <%= @trip.user.last_name %>
      </div>
    </div>
    <div class="trip-description">
      <h3>T H E  -  T R I P</h3>
      <div class="more-description">
        <p><%= @trip.description  %></p>
        <span>About the car:<br><%= @trip.car %></span>
      </div>
    </div>
  </div>
  <!-- MEMBERS -->
  <div class="surfer-box-cont">
    <h3>C u r r e n t - t e a m </h3>
    <div class="surfers-box">
      <% @trip.participants.each do |participant| %>
      <% if participant.status == 'accepted' %>
      <div class="surfers-profile">
        <div class="banner-avatar img-circle" style="background-image: url(<%= participant.user.facebook_picture_url.gsub('square', 'large') %>)">
        </div>
        <p><%= participant.user.first_name %> <%= participant.user.last_name %></p>
      </div>
      <% end %>
      <% end %>
      <% @remaining_spots.times do %>
      <div class="available-seat">
        <div class="empty-user img-circle">
        </div>
        <p>Available seat</p>
      </div>
      <% end %>
    </div>
    <% if @remaining_spots > 0 %>
    <span><%= @remaining_spots %> seats remaining</span>
    <% end %>
  </div>
  <!-- JOIN -->
  <div class="join-team">
    <div class="join-the-team-title">
      <h1><span>JOIN</span><br>
      the team</h1>
    </div>
    <div class="join-team-action">
      <% if @trip.has_participant(current_user)[:status] == false %>        <%= simple_form_for([@trip, @participant]) do |f| %>
      <div class="form-inputs">
        <%= f.input :message, required: true, label: false, placeholder: 'Write a short message to the organizer :)'%>
      </div>
      <div class="form-actions">
        <%= f.button :submit, "Ask to join", class: 'btn btn-primary-colored' %>
      </div>
      <% end %>
      <% elsif @trip.has_participant(current_user)[:status] == 'pending' %>
      <p>You have a pending request to join this trip</p>
      <%= link_to "Cancel request", trip_participant_path(@trip, @trip.has_participant(current_user)[:participant] , status: "cancelled"), method: :patch, class: 'btn btn-info' %>
      <% elsif @trip.has_participant(current_user)[:status] == 'waiting list' %>
      <p>You are on the waiting list for this trip</p>
      <% elsif @trip.has_participant(current_user)[:status] == 'accepted' %>
      <p>You have joined this trip !</p>
      <% elsif @trip.has_participant(current_user)[:status] == 'declined' %>
      <p><%= @trip.user.first_name %> has declined your request to join this trip</p>
      <% elsif @trip.has_participant(current_user)[:status] == 'cancelled' %>
      <p>You have cancelled your request</p>
      <% else %>
      <p>Sorry, you cannot join this trip</p>
      <% end %>
    </div>
  </div>
  <!-- CHAT -->

  <h2>Questions and answers</h2>
   <!-- previous messages -->
  <div class="container">
      <div class="board-outline" id="message-board-public">
        <!-- Action-cable here (JS) -->
        <% @comments.each do |comment| %>
        <%= render 'comments/show', comment: comment %>
        <% end %>
      </div>
    </div>
  </div>
</div>
  <!-- Chat box -->
  <div class="container">
    <div class="comment-box">
      <div class="question-box">
        <%= render 'comments/form', trip: @trip, comment: @comment %>
      </div>
    </div>
  </div>


<!-- JS (incl. map) -->
<% content_for(:after_js) do %>
<script>
$(document).ready(function() {
var handler = Gmaps.build('Google');
handler.buildMap({ internal: { id: 'map' } }, function() {
markers = handler.addMarkers(<%= raw @hash.to_json %>);
handler.bounds.extendWith(markers);
handler.fitMapToBounds();
if (markers.length === 0) {
handler.getMap().setZoom(2);
} else if (markers.length == 1) {
handler.getMap().setZoom(14);
}
});
App.comments = App.cable.subscriptions.create({ channel: 'CommentsChannel', trip_id: <%= @trip.id %> }, {
received: function(data) {
var new_comment = data.comment;
document.getElementById('message-board-public').insertAdjacentHTML('afterbegin', new_comment );
document.querySelector("#comment_content").value = '';
}
});
});
</script>
<% end %>
<!-- JS MAP -->
<% content_for(:after_js) do %>
<%= javascript_tag do %>
$(document).ready(function() {
var handler = Gmaps.build('Google');
handler.buildMap({ internal: { id: 'map' } }, function() {
markers = handler.addMarkers(<%= raw @hash.to_json %>);
handler.bounds.extendWith(markers);
handler.fitMapToBounds();
if (markers.length == 0) {
handler.getMap().setZoom(2);
} else if (markers.length == 1) {
handler.getMap().setZoom(14);
}
});
});
<% end %>
<% end %>
